<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Digital Detective</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=IBM+Plex+Mono:wght@400;600&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0f0e0c; font-family: 'Courier Prime', monospace; color: #d4c9a8; min-height: 100vh; }
    :root { --ink: #d4c9a8; --paper: #1a1814; --dark: #0f0e0c; --red: #c0392b; --yellow: #d4a017; --green: #2e7d32; --accent: #8b6914; --border: #3a3228; }
    .grain { position: fixed; inset: 0; pointer-events: none; z-index: 999; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"); opacity: 0.3; }
    .scanlines { position: fixed; inset: 0; pointer-events: none; z-index: 998; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px); }
    .app-wrap { max-width: 780px; margin: 0 auto; padding: 40px 24px 80px; position: relative; z-index: 1; }

    /* Auth Bar */
    .auth-bar { display: flex; justify-content: flex-end; align-items: center; gap: 12px; margin-bottom: 24px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
    .auth-bar .user-info { color: var(--accent); }
    .auth-btn { background: none; border: 1px solid var(--border); color: var(--ink); padding: 6px 14px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; font-size: 12px; transition: all 0.2s; }
    .auth-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* Header */
    .header { text-align: center; margin-bottom: 40px; }
    .header-badge { display: inline-block; border: 1px solid var(--accent); padding: 4px 16px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 3px; color: var(--accent); margin-bottom: 20px; }
    .header-title { font-family: 'Special Elite', serif; font-size: clamp(32px, 6vw, 52px); color: #f0e6c8; letter-spacing: 2px; text-shadow: 2px 2px 0 rgba(0,0,0,0.5); }
    .header-sub { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #6b6050; margin-top: 8px; letter-spacing: 2px; }

    /* Free banner */
    .free-banner { background: rgba(139,105,20,0.1); border: 1px solid var(--accent); padding: 10px 16px; margin-bottom: 24px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--accent); display: flex; justify-content: space-between; align-items: center; }
    .upgrade-link { color: var(--accent); text-decoration: underline; cursor: pointer; background: none; border: none; font-family: 'IBM Plex Mono', monospace; font-size: 12px; }

    /* Search */
    .search-block { margin-bottom: 32px; }
    .search-label { font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 2px; color: #6b6050; margin-bottom: 10px; }
    .search-row { display: flex; gap: 8px; }
    .search-input { flex: 1; background: var(--paper); border: 1px solid var(--border); color: var(--ink); padding: 14px 16px; font-family: 'IBM Plex Mono', monospace; font-size: 14px; outline: none; transition: border-color 0.2s; }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: #4a4030; }
    .search-btn { background: var(--accent); border: none; color: #0f0e0c; padding: 14px 28px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; font-weight: 600; cursor: pointer; letter-spacing: 1px; transition: opacity 0.2s; }
    .search-btn:hover { opacity: 0.85; }
    .search-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* Status */
    .status-log { background: var(--paper); border: 1px solid var(--border); padding: 16px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #6b6050; min-height: 60px; display: none; margin-bottom: 24px; }
    .status-log.visible { display: block; }
    .status-line { margin: 2px 0; }
    .status-line.active { color: var(--accent); }

    /* Error */
    .error-box { background: rgba(192,57,43,0.1); border: 1px solid var(--red); padding: 12px 16px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: #e74c3c; display: none; margin-bottom: 24px; }
    .error-box.visible { display: block; }

    /* Report */
    .report { display: none; }
    .report.visible { display: block; }
    .verdict-block { border: 2px solid var(--border); padding: 28px; margin-bottom: 24px; text-align: center; position: relative; overflow: hidden; }
    .verdict-block::before { content: ''; position: absolute; inset: 0; opacity: 0.04; background: repeating-linear-gradient(45deg, currentColor, currentColor 1px, transparent 1px, transparent 8px); }
    .verdict-block.GREEN { border-color: var(--green); }
    .verdict-block.YELLOW { border-color: var(--yellow); }
    .verdict-block.RED { border-color: var(--red); }
    .verdict-stamp { font-family: 'Special Elite', serif; font-size: 48px; font-weight: bold; letter-spacing: 6px; margin-bottom: 8px; }
    .verdict-stamp.GREEN { color: var(--green); }
    .verdict-stamp.YELLOW { color: var(--yellow); }
    .verdict-stamp.RED { color: var(--red); }
    .verdict-score { font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: #6b6050; margin-bottom: 12px; }
    .verdict-quote { font-style: italic; font-size: 16px; color: #a09070; }
    .section-label { font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 3px; color: var(--accent); margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
    .findings-list { margin-bottom: 24px; }
    .finding-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(58,50,40,0.5); }
    .finding-icon { font-size: 18px; flex-shrink: 0; width: 28px; }
    .finding-text { font-size: 14px; line-height: 1.5; color: #b0a080; }
    .finding-tag { display: inline-block; font-family: 'IBM Plex Mono', monospace; font-size: 10px; padding: 2px 6px; margin-right: 8px; font-weight: 600; vertical-align: middle; }
    .tag-risk { background: rgba(192,57,43,0.2); color: #e74c3c; }
    .tag-caution { background: rgba(212,160,23,0.2); color: var(--yellow); }
    .tag-ok { background: rgba(46,125,50,0.2); color: #4caf50; }
    .narrative-block { background: var(--paper); border-left: 3px solid var(--accent); padding: 16px 20px; font-size: 14px; line-height: 1.7; color: #a09070; margin-bottom: 24px; font-style: italic; }
    .raw-toggle { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--accent); cursor: pointer; margin-bottom: 12px; user-select: none; }
    .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; max-height: 0; overflow: hidden; transition: max-height 0.3s; }
    .data-grid.open { max-height: 2000px; }
    .data-cell { background: var(--paper); border: 1px solid var(--border); padding: 10px 12px; }
    .data-cell-label { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #6b6050; margin-bottom: 4px; letter-spacing: 1px; }
    .data-cell-value { font-size: 12px; color: #a09070; }

    /* Auth Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.visible { display: flex; }
    .modal { background: #1a1814; border: 1px solid var(--border); padding: 36px; width: 100%; max-width: 400px; position: relative; }
    .modal-title { font-family: 'Special Elite', serif; font-size: 22px; color: #f0e6c8; margin-bottom: 8px; }
    .modal-sub { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: #6b6050; margin-bottom: 24px; }
    .modal-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: #6b6050; font-size: 18px; cursor: pointer; }
    .modal-input { width: 100%; background: #0f0e0c; border: 1px solid var(--border); color: var(--ink); padding: 12px 14px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; outline: none; margin-bottom: 12px; display: block; }
    .modal-input:focus { border-color: var(--accent); }
    .modal-btn { width: 100%; background: var(--accent); border: none; color: #0f0e0c; padding: 13px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; font-weight: 600; cursor: pointer; letter-spacing: 1px; margin-bottom: 12px; }
    .modal-btn:hover { opacity: 0.85; }
    .modal-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .modal-switch { text-align: center; font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #6b6050; }
    .modal-switch span { color: var(--accent); cursor: pointer; text-decoration: underline; }
    .modal-error { background: rgba(192,57,43,0.1); border: 1px solid var(--red); color: #e74c3c; padding: 10px 12px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; margin-bottom: 12px; display: none; }
    .modal-error.visible { display: block; }
    .modal-success { background: rgba(46,125,50,0.1); border: 1px solid var(--green); color: #4caf50; padding: 10px 12px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; margin-bottom: 12px; display: none; }
    .modal-success.visible { display: block; }
  </style>
</head>
<body>
  <div class="grain"></div>
  <div class="scanlines"></div>

  <!-- Auth Modal -->
  <div class="modal-overlay" id="authModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal()">‚úï</button>
      <div class="modal-title" id="modalTitle">Sign In</div>
      <div class="modal-sub" id="modalSub">ACCESS THE DETECTIVE'S CASE FILES</div>
      <div class="modal-error" id="modalError"></div>
      <div class="modal-success" id="modalSuccess"></div>
      <input class="modal-input" type="email" id="authEmail" placeholder="email address" />
      <input class="modal-input" type="password" id="authPassword" placeholder="password" onkeydown="if(event.key==='Enter')submitAuth()" />
      <button class="modal-btn" id="authSubmitBtn" onclick="submitAuth()">SIGN IN</button>
      <div class="modal-switch" id="modalSwitch">No account? <span onclick="toggleAuthMode()">Sign up for free</span></div>
    </div>
  </div>

  <div class="app-wrap">
    <!-- Auth Bar -->
    <div class="auth-bar">
      <span class="user-info" id="userInfo"></span>
      <button class="auth-btn" id="authBarBtn" onclick="openModal()">SIGN IN</button>
    </div>

    <!-- Header -->
    <div class="header">
      <div class="header-badge">CASE FILE SYSTEM v4.0</div>
      <div class="header-title">üïµÔ∏è The Digital Detective</div>
      <div class="header-sub">// 20-SOURCE GLOBAL INTELLIGENCE ENGINE //</div>
    </div>

    <!-- Free tier banner -->
    <div class="free-banner" id="freeBanner" style="display:none">
      <span id="freeBannerText">üîç FREE TIER ‚Äî 3 investigations/day</span>
      <button class="upgrade-link" onclick="openModal()">Upgrade to Pro ‚Üí</button>
    </div>

    <!-- Search -->
    <div class="search-block">
      <div class="search-label">// ENTER TARGET URL FOR INVESTIGATION</div>
      <div class="search-row">
        <input class="search-input" type="text" id="targetInput" placeholder="e.g. suspicioussite.com" onkeydown="if(event.key==='Enter')runInvestigation()" />
        <button class="search-btn" id="searchBtn" onclick="runInvestigation()">INVESTIGATE</button>
      </div>
    </div>

    <!-- Status Log -->
    <div class="status-log" id="statusLog">
      <div class="status-line active" id="statusText">‚ü≥ Initialising investigation...</div>
    </div>

    <!-- Error -->
    <div class="error-box" id="errorBox"></div>

    <!-- Report -->
    <div class="report" id="report">
      <div class="verdict-block" id="verdictBlock">
        <div class="verdict-stamp" id="verdictStamp"></div>
        <div class="verdict-score" id="verdictScore"></div>
        <div class="verdict-quote" id="verdictQuote"></div>
      </div>
      <div class="section-label">// FIELD FINDINGS</div>
      <div class="findings-list" id="findingsList"></div>
      <div class="section-label">// DETECTIVE'S NARRATIVE</div>
      <div class="narrative-block" id="narrativeText"></div>
      <div class="raw-toggle" onclick="toggleRaw()">[<span id="rawToggle">+</span>] RAW INTELLIGENCE DATA</div>
      <div class="data-grid" id="dataGrid"></div>
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://detective-app-production-7080.up.railway.app";
    const SUPABASE_URL = "REPLACE_WITH_YOUR_SUPABASE_URL";
    const SUPABASE_ANON_KEY = "REPLACE_WITH_YOUR_SUPABASE_ANON_KEY";

    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUser = null;
    let userToken = null;
    let authMode = "signin";

    sb.auth.onAuthStateChange((event, session) => {
      if (session) {
        currentUser = session.user;
        userToken = session.access_token;
      } else {
        currentUser = null;
        userToken = null;
      }
      updateAuthUI();
    });

    function updateAuthUI() {
      const userInfo = document.getElementById("userInfo");
      const authBarBtn = document.getElementById("authBarBtn");
      const freeBanner = document.getElementById("freeBanner");
      if (currentUser) {
        userInfo.textContent = currentUser.email;
        authBarBtn.textContent = "SIGN OUT";
        authBarBtn.onclick = signOut;
        freeBanner.style.display = "flex";
      } else {
        userInfo.textContent = "";
        authBarBtn.textContent = "SIGN IN";
        authBarBtn.onclick = openModal;
        freeBanner.style.display = "none";
      }
    }

    async function signOut() { await sb.auth.signOut(); }

    function openModal() { document.getElementById("authModal").classList.add("visible"); document.getElementById("authEmail").focus(); }
    function closeModal() { document.getElementById("authModal").classList.remove("visible"); }

    function toggleAuthMode() {
      authMode = authMode === "signin" ? "signup" : "signin";
      const s = authMode === "signin";
      document.getElementById("modalTitle").textContent = s ? "Sign In" : "Create Account";
      document.getElementById("modalSub").textContent = s ? "ACCESS THE DETECTIVE'S CASE FILES" : "3 FREE INVESTIGATIONS PER DAY";
      document.getElementById("authSubmitBtn").textContent = s ? "SIGN IN" : "CREATE ACCOUNT";
      document.getElementById("modalSwitch").innerHTML = s
        ? `No account? <span onclick="toggleAuthMode()">Sign up for free</span>`
        : `Already have an account? <span onclick="toggleAuthMode()">Sign in</span>`;
      document.getElementById("modalError").classList.remove("visible");
      document.getElementById("modalSuccess").classList.remove("visible");
    }

    async function submitAuth() {
      const email = document.getElementById("authEmail").value.trim();
      const password = document.getElementById("authPassword").value;
      const btn = document.getElementById("authSubmitBtn");
      const errBox = document.getElementById("modalError");
      const successBox = document.getElementById("modalSuccess");

      if (!email || !password) { errBox.textContent = "Please enter email and password."; errBox.classList.add("visible"); return; }

      btn.disabled = true;
      btn.textContent = "PLEASE WAIT...";
      errBox.classList.remove("visible");
      successBox.classList.remove("visible");

      const result = authMode === "signin"
        ? await sb.auth.signInWithPassword({ email, password })
        : await sb.auth.signUp({ email, password });

      btn.disabled = false;
      btn.textContent = authMode === "signin" ? "SIGN IN" : "CREATE ACCOUNT";

      if (result.error) {
        errBox.textContent = result.error.message;
        errBox.classList.add("visible");
      } else if (authMode === "signup" && !result.data.session) {
        successBox.textContent = "‚úì Account created! Check your email to confirm, then sign in.";
        successBox.classList.add("visible");
      } else {
        closeModal();
      }
    }

    async function runInvestigation() {
      const target = document.getElementById("targetInput").value.trim();
      if (!target) return;

      document.getElementById("report").classList.remove("visible");
      document.getElementById("errorBox").classList.remove("visible");

      const statusLog = document.getElementById("statusLog");
      const statusText = document.getElementById("statusText");
      statusLog.classList.add("visible");

      const steps = [
        "‚ü≥ Opening case file...",
        "‚ü≥ Querying domain registry...",
        "‚ü≥ Running malware scan across 93 engines...",
        "‚ü≥ Checking Google Safe Browsing...",
        "‚ü≥ Verifying SSL certificate live...",
        "‚ü≥ Searching 20 global registries...",
        "‚ü≥ Scanning community signals...",
        "‚ü≥ Checking UN & ICIJ sanctions lists...",
        "‚ü≥ Running URLScan live page analysis...",
        "‚ü≥ Checking Wayback Machine history...",
        "‚ü≥ Consulting AI analyst...",
        "‚ü≥ Compiling final report..."
      ];

      let i = 0;
      const interval = setInterval(() => {
        if (i < steps.length) { statusText.textContent = steps[i]; i++; }
      }, 1200);

      document.getElementById("searchBtn").disabled = true;

      try {
        const body = { target };
        if (userToken) body.user_token = userToken;

        const res = await fetch(`${BACKEND_URL}/investigate`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        clearInterval(interval);
        document.getElementById("searchBtn").disabled = false;
        statusLog.classList.remove("visible");

        if (res.status === 429) {
          showError("Free tier limit reached ‚Äî 3 investigations per day. Sign in and upgrade to Pro for unlimited access.");
          return;
        }
        if (!res.ok) {
          const err = await res.json();
          showError(err.detail || "Investigation failed. Please try again.");
          return;
        }

        renderReport(await res.json());

      } catch (err) {
        clearInterval(interval);
        document.getElementById("searchBtn").disabled = false;
        statusLog.classList.remove("visible");
        showError("Could not reach the investigation server. Please try again.");
      }
    }

    function renderReport(r) {
      const block = document.getElementById("verdictBlock");
      const stamp = document.getElementById("verdictStamp");
      block.className = "verdict-block " + r.verdict;
      stamp.className = "verdict-stamp " + r.verdict;
      const labels = { GREEN: "‚úì SAFE", YELLOW: "‚ö† CAUTION", RED: "‚úó DANGER" };
      stamp.textContent = labels[r.verdict] || r.verdict;
      document.getElementById("verdictScore").textContent = `RISK SCORE: ${r.score}/100`;
      document.getElementById("verdictQuote").textContent = '"' + r.verdict_summary + '"';

      const findingsList = document.getElementById("findingsList");
      findingsList.innerHTML = "";
      (r.findings || []).forEach(f => {
        const tagClass = f.tag === "RISK" ? "tag-risk" : f.tag === "OK" ? "tag-ok" : "tag-caution";
        findingsList.innerHTML += `<div class="finding-item"><div class="finding-icon">${f.icon}</div><div class="finding-text"><span class="finding-tag ${tagClass}">${f.tag}</span>${f.text}</div></div>`;
      });

      document.getElementById("narrativeText").textContent = r.narrative;

      const grid = document.getElementById("dataGrid");
      grid.innerHTML = "";
      Object.entries(r.raw_labels || {}).forEach(([k, v]) => {
        grid.innerHTML += `<div class="data-cell"><div class="data-cell-label">${k}</div><div class="data-cell-value">${v}</div></div>`;
      });

      document.getElementById("report").classList.add("visible");
      document.getElementById("report").scrollIntoView({ behavior: "smooth" });
    }

    function toggleRaw() {
      const grid = document.getElementById("dataGrid");
      const toggle = document.getElementById("rawToggle");
      grid.classList.toggle("open");
      toggle.textContent = grid.classList.contains("open") ? "‚àí" : "+";
    }

    function showError(msg) {
      const box = document.getElementById("errorBox");
      box.textContent = "‚ö† " + msg;
      box.classList.add("visible");
    }
  </script>
