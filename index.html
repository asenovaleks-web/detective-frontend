<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>The Digital Detective</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=IBM+Plex+Mono:wght@400;600&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0f0e0c; font-family: 'Courier Prime', monospace; color: #d4c9a8; min-height: 100vh; }
    :root { --ink: #d4c9a8; --paper: #1a1814; --dark: #0f0e0c; --red: #c0392b; --yellow: #d4a017; --green: #2e7d32; --accent: #8b6914; --border: #3a3228; }
    .grain { position: fixed; inset: 0; pointer-events: none; z-index: 999; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E"); opacity: 0.3; }
    .scanlines { position: fixed; inset: 0; pointer-events: none; z-index: 998; background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px); }
    .app-wrap { max-width: 780px; margin: 0 auto; padding: 40px 24px 80px; position: relative; z-index: 1; }
    .auth-bar { display: flex; justify-content: flex-end; align-items: center; gap: 12px; margin-bottom: 24px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
    .auth-bar .user-info { color: var(--accent); }
    .auth-btn { background: none; border: 1px solid var(--border); color: var(--ink); padding: 6px 14px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; font-size: 12px; transition: all 0.2s; }
    .auth-btn:hover { border-color: var(--accent); color: var(--accent); }
    .header { text-align: center; margin-bottom: 40px; }
    .header-badge { display: inline-block; border: 1px solid var(--accent); padding: 4px 16px; font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 3px; color: var(--accent); margin-bottom: 20px; }
    .header-title { font-family: 'Special Elite', serif; font-size: clamp(32px, 6vw, 52px); color: #f0e6c8; letter-spacing: 2px; text-shadow: 2px 2px 0 rgba(0,0,0,0.5); }
    .header-sub { font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #6b6050; margin-top: 8px; letter-spacing: 2px; }
    .free-banner { background: rgba(139,105,20,0.1); border: 1px solid var(--accent); padding: 10px 16px; margin-bottom: 24px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: var(--accent); display: flex; justify-content: space-between; align-items: center; }
    .upgrade-link { color: var(--accent); text-decoration: underline; cursor: pointer; background: none; border: none; font-family: 'IBM Plex Mono', monospace; font-size: 12px; }
    .search-block { margin-bottom: 32px; }
    .search-label { font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 2px; color: #6b6050; margin-bottom: 10px; }
    .search-row { display: flex; gap: 8px; }
    .search-input { flex: 1; background: var(--paper); border: 1px solid var(--border); color: var(--ink); padding: 14px 16px; font-family: 'IBM Plex Mono', monospace; font-size: 14px; outline: none; transition: border-color 0.2s; }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: #4a4030; }
    .search-btn { background: var(--accent); border: none; color: #0f0e0c; padding: 14px 28px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; font-weight: 600; cursor: pointer; letter-spacing: 1px; transition: opacity 0.2s; }
    .search-btn:hover { opacity: 0.85; }
    .search-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .status-log { background: var(--paper); border: 1px solid var(--border); padding: 16px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #6b6050; min-height: 60px; display: none; margin-bottom: 24px; }
    .status-log.visible { display: block; }
    .status-line { margin: 2px 0; color: var(--accent); }
    .error-box { background: rgba(192,57,43,0.1); border: 1px solid var(--red); padding: 12px 16px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: #e74c3c; display: none; margin-bottom: 24px; }
    .error-box.visible { display: block; }
    .success-box { background: rgba(46,125,50,0.1); border: 1px solid var(--green); padding: 12px 16px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: #4caf50; display: none; margin-bottom: 24px; }
    .success-box.visible { display: block; }
    .report { display: none; }
    .report.visible { display: block; }
    .verdict-block { border: 2px solid var(--border); padding: 28px; margin-bottom: 24px; text-align: center; position: relative; overflow: hidden; }
    .verdict-block::before { content: ''; position: absolute; inset: 0; opacity: 0.04; background: repeating-linear-gradient(45deg, currentColor, currentColor 1px, transparent 1px, transparent 8px); }
    .verdict-block.GREEN { border-color: var(--green); }
    .verdict-block.YELLOW { border-color: var(--yellow); }
    .verdict-block.RED { border-color: var(--red); }
    .verdict-stamp { font-family: 'Special Elite', serif; font-size: 48px; font-weight: bold; letter-spacing: 6px; margin-bottom: 8px; }
    .verdict-stamp.GREEN { color: var(--green); }
    .verdict-stamp.YELLOW { color: var(--yellow); }
    .verdict-stamp.RED { color: var(--red); }
    .verdict-score { font-family: 'IBM Plex Mono', monospace; font-size: 13px; color: #6b6050; margin-bottom: 12px; }
    .verdict-quote { font-style: italic; font-size: 16px; color: #a09070; }
    .section-label { font-family: 'IBM Plex Mono', monospace; font-size: 11px; letter-spacing: 3px; color: var(--accent); margin-bottom: 12px; padding-bottom: 6px; border-bottom: 1px solid var(--border); }
    .findings-list { margin-bottom: 24px; }
    .finding-item { display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid rgba(58,50,40,0.5); }
    .finding-icon { font-size: 18px; flex-shrink: 0; width: 28px; }
    .finding-text { font-size: 14px; line-height: 1.5; color: #b0a080; }
    .finding-tag { display: inline-block; font-family: 'IBM Plex Mono', monospace; font-size: 10px; padding: 2px 6px; margin-right: 8px; font-weight: 600; vertical-align: middle; }
    .tag-risk { background: rgba(192,57,43,0.2); color: #e74c3c; }
    .tag-caution { background: rgba(212,160,23,0.2); color: var(--yellow); }
    .tag-ok { background: rgba(46,125,50,0.2); color: #4caf50; }
    .narrative-block { background: var(--paper); border-left: 3px solid var(--accent); padding: 16px 20px; font-size: 14px; line-height: 1.7; color: #a09070; margin-bottom: 24px; font-style: italic; }
    .raw-toggle { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: var(--accent); cursor: pointer; margin-bottom: 12px; user-select: none; }
    .data-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 8px; max-height: 0; overflow: hidden; transition: max-height 0.3s; }
    .data-grid.open { max-height: 2000px; }
    .data-cell { background: var(--paper); border: 1px solid var(--border); padding: 10px 12px; }
    .data-cell-label { font-family: 'IBM Plex Mono', monospace; font-size: 10px; color: #6b6050; margin-bottom: 4px; letter-spacing: 1px; }
    .data-cell-value { font-size: 12px; color: #a09070; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; align-items: center; justify-content: center; }
    .modal-overlay.visible { display: flex; }
    .modal { background: #1a1814; border: 1px solid var(--border); padding: 36px; width: 100%; max-width: 400px; position: relative; }
    .modal-title { font-family: 'Special Elite', serif; font-size: 22px; color: #f0e6c8; margin-bottom: 8px; }
    .modal-sub { font-family: 'IBM Plex Mono', monospace; font-size: 11px; color: #6b6050; margin-bottom: 24px; }
    .modal-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: #6b6050; font-size: 18px; cursor: pointer; }
    .modal-input { width: 100%; background: #0f0e0c; border: 1px solid var(--border); color: var(--ink); padding: 12px 14px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; outline: none; margin-bottom: 12px; display: block; }
    .modal-input:focus { border-color: var(--accent); }
    .modal-btn { width: 100%; background: var(--accent); border: none; color: #0f0e0c; padding: 13px; font-family: 'IBM Plex Mono', monospace; font-size: 13px; font-weight: 600; cursor: pointer; letter-spacing: 1px; margin-bottom: 12px; }
    .modal-btn:hover { opacity: 0.85; }
    .modal-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .modal-switch { text-align: center; font-family: 'IBM Plex Mono', monospace; font-size: 12px; color: #6b6050; }
    .modal-switch span { color: var(--accent); cursor: pointer; text-decoration: underline; }
    .modal-msg { padding: 10px 12px; font-family: 'IBM Plex Mono', monospace; font-size: 12px; margin-bottom: 12px; display: none; }
    .modal-msg.error { background: rgba(192,57,43,0.1); border: 1px solid var(--red); color: #e74c3c; }
    .modal-msg.success { background: rgba(46,125,50,0.1); border: 1px solid var(--green); color: #4caf50; }
    .modal-msg.visible { display: block; }
  </style>
</head>
<body>
  <div class="grain"></div>
  <div class="scanlines"></div>

  <div class="modal-overlay" id="authModal">
    <div class="modal">
      <button class="modal-close" onclick="closeModal()">x</button>
      <div class="modal-title" id="modalTitle">Sign In</div>
      <div class="modal-sub" id="modalSub">ACCESS THE DETECTIVE'S CASE FILES</div>
      <div class="modal-msg" id="modalMsg"></div>
      <input class="modal-input" type="email" id="authEmail" placeholder="email address" />
      <input class="modal-input" type="password" id="authPassword" placeholder="password" onkeydown="if(event.key==='Enter')submitAuth()" />
      <button class="modal-btn" id="authSubmitBtn" onclick="submitAuth()">SIGN IN</button>
      <div class="modal-switch" id="modalSwitch">No account? <span onclick="toggleAuthMode()">Sign up for free</span></div>
    </div>
  </div>

  <div class="app-wrap">
    <div class="auth-bar">
      <span class="user-info" id="userInfo"></span>
      <button class="auth-btn" id="authBarBtn" onclick="openModal()">SIGN IN</button>
    </div>
    <div class="header">
      <div class="header-badge">CASE FILE SYSTEM v4.0</div>
      <div class="header-title">The Digital Detective</div>
      <div class="header-sub">// 20-SOURCE GLOBAL INTELLIGENCE ENGINE //</div>
    </div>
    <div class="free-banner" id="freeBanner" style="display:none">
      <span>FREE TIER - 3 investigations/day</span>
      <button class="upgrade-link" id="upgradeBtn" onclick="upgradeToPro()">Upgrade to Pro</button>
    </div>
    <div class="success-box" id="successBox"></div>
    <div class="search-block">
      <div class="search-label">// ENTER TARGET URL FOR INVESTIGATION</div>
      <div class="search-row">
        <input class="search-input" type="text" id="targetInput" placeholder="e.g. suspicioussite.com" onkeydown="if(event.key==='Enter')runInvestigation()" />
        <button class="search-btn" id="searchBtn" onclick="runInvestigation()">INVESTIGATE</button>
      </div>
    </div>
    <div class="status-log" id="statusLog">
      <div class="status-line" id="statusText">Initialising investigation...</div>
    </div>
    <div class="error-box" id="errorBox"></div>
    <div class="report" id="report">
      <div class="verdict-block" id="verdictBlock">
        <div class="verdict-stamp" id="verdictStamp"></div>
        <div class="verdict-score" id="verdictScore"></div>
        <div class="verdict-quote" id="verdictQuote"></div>
      </div>
      <div class="section-label">// FIELD FINDINGS</div>
      <div class="findings-list" id="findingsList"></div>
      <div class="section-label">// DETECTIVE'S NARRATIVE</div>
      <div class="narrative-block" id="narrativeText"></div>
      <div class="raw-toggle" onclick="toggleRaw()">[<span id="rawToggle">+</span>] RAW INTELLIGENCE DATA</div>
      <div class="data-grid" id="dataGrid"></div>
    </div>
  </div>

  <script>
    var BACKEND = "https://detective-app-production-7080.up.railway.app";
    var SB_URL  = "https://harhjuykvkfwksccjjxq.supabase.co";
    var SB_KEY  = "sb_publishable_gNTIfFSDai7wWPMPIVM-Vg_2rthrcNV";

    var currentUser = null;
    var userToken   = null;
    var authMode    = "signin";

    // ── Supabase auth via fetch ───────────────────────────────────────────────
    function sbSignIn(email, password) {
      return fetch(SB_URL + "/auth/v1/token?grant_type=password", {
        method: "POST",
        headers: { "Content-Type": "application/json", "apikey": SB_KEY },
        body: JSON.stringify({ email: email, password: password }),
      }).then(function(r) { return r.json(); });
    }

    function sbSignUp(email, password) {
      return fetch(SB_URL + "/auth/v1/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json", "apikey": SB_KEY },
        body: JSON.stringify({ email: email, password: password }),
      }).then(function(r) { return r.json(); });
    }

    function sbSignOut() {
      if (userToken) {
        fetch(SB_URL + "/auth/v1/logout", {
          method: "POST",
          headers: { "Authorization": "Bearer " + userToken, "apikey": SB_KEY },
        });
      }
      currentUser = null;
      userToken = null;
      localStorage.removeItem("dd_token");
      localStorage.removeItem("dd_user");
      updateAuthUI();
    }

    // Restore session on load
    window.addEventListener("load", function() {
      var saved     = localStorage.getItem("dd_token");
      var savedUser = localStorage.getItem("dd_user");
      if (saved && saved !== "null" && savedUser && savedUser !== "null") {
        try {
          userToken   = saved;
          currentUser = JSON.parse(savedUser);
          console.log("Session restored for:", currentUser.email);
          updateAuthUI();
        } catch(e) {
          localStorage.removeItem("dd_token");
          localStorage.removeItem("dd_user");
        }
      }
      // Handle Stripe return
      var params = new URLSearchParams(window.location.search);
      if (params.get("upgrade") === "success") {
        var box = document.getElementById("successBox");
        box.textContent = "Welcome to Pro! Your account has been upgraded. Unlimited investigations unlocked.";
        box.classList.add("visible");
        window.history.replaceState({}, "", window.location.pathname);
      }
    });

    function updateAuthUI() {
      var userInfo   = document.getElementById("userInfo");
      var authBarBtn = document.getElementById("authBarBtn");
      var freeBanner = document.getElementById("freeBanner");
      if (currentUser) {
        userInfo.textContent     = currentUser.email;
        authBarBtn.textContent   = "SIGN OUT";
        authBarBtn.onclick       = sbSignOut;
        freeBanner.style.display = "flex";
      } else {
        userInfo.textContent     = "";
        authBarBtn.textContent   = "SIGN IN";
        authBarBtn.onclick       = openModal;
        freeBanner.style.display = "none";
      }
    }

    // ── Modal ─────────────────────────────────────────────────────────────────
    function openModal()  { document.getElementById("authModal").classList.add("visible"); document.getElementById("authEmail").focus(); }
    function closeModal() { document.getElementById("authModal").classList.remove("visible"); }

    function showModalMsg(text, type) {
      var el = document.getElementById("modalMsg");
      el.textContent = text;
      el.className = "modal-msg " + type + " visible";
    }

    function toggleAuthMode() {
      authMode = authMode === "signin" ? "signup" : "signin";
      var s = authMode === "signin";
      document.getElementById("modalTitle").textContent    = s ? "Sign In" : "Create Account";
      document.getElementById("modalSub").textContent      = s ? "ACCESS THE DETECTIVE'S CASE FILES" : "3 FREE INVESTIGATIONS PER DAY";
      document.getElementById("authSubmitBtn").textContent = s ? "SIGN IN" : "CREATE ACCOUNT";
      document.getElementById("modalSwitch").innerHTML     = s
        ? 'No account? <span onclick="toggleAuthMode()">Sign up for free</span>'
        : 'Already have an account? <span onclick="toggleAuthMode()">Sign in</span>';
      document.getElementById("modalMsg").className = "modal-msg";
    }

    function submitAuth() {
      var email    = document.getElementById("authEmail").value.trim();
      var password = document.getElementById("authPassword").value;
      var btn      = document.getElementById("authSubmitBtn");

      if (!email || !password) { showModalMsg("Please enter email and password.", "error"); return; }

      btn.disabled    = true;
      btn.textContent = "PLEASE WAIT...";

      var promise = authMode === "signin" ? sbSignIn(email, password) : sbSignUp(email, password);

      promise.then(function(data) {
        btn.disabled    = false;
        btn.textContent = authMode === "signin" ? "SIGN IN" : "CREATE ACCOUNT";

        if (data.error || data.error_description) {
          showModalMsg(data.error_description || data.error || "Authentication failed.", "error");
          return;
        }
        if (authMode === "signup" && !data.access_token) {
          showModalMsg("Account created! Check your email to confirm, then sign in.", "success");
          return;
        }
        userToken   = data.access_token;
        currentUser = data.user;
        localStorage.setItem("dd_token", userToken);
        localStorage.setItem("dd_user", JSON.stringify(currentUser));
        updateAuthUI();
        closeModal();
      }).catch(function(e) {
        btn.disabled    = false;
        btn.textContent = authMode === "signin" ? "SIGN IN" : "CREATE ACCOUNT";
        showModalMsg("Connection error. Please try again.", "error");
      });
    }

    // ── Stripe upgrade ────────────────────────────────────────────────────────
    function upgradeToPro() {
      if (!currentUser || !userToken || userToken === "null") {
        openModal();
        return;
      }
      var btn = document.getElementById("upgradeBtn");
      btn.textContent = "REDIRECTING...";
      btn.disabled    = true;
      console.log("Sending token:", userToken.substring(0, 30) + "...");
      console.log("User email:", currentUser.email);

      fetch(BACKEND + "/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ user_token: userToken, user_email: currentUser.email }),
      }).then(function(r) {
        return r.json();
      }).then(function(data) {
        if (data.checkout_url) {
          window.location.href = data.checkout_url;
        } else {
          alert("Could not start checkout. Please try again.");
          btn.textContent = "Upgrade to Pro";
          btn.disabled    = false;
        }
      }).catch(function() {
        alert("Could not start checkout. Please try again.");
        btn.textContent = "Upgrade to Pro";
        btn.disabled    = false;
      });
    }

    // ── Investigation ─────────────────────────────────────────────────────────
    function runInvestigation() {
      var target = document.getElementById("targetInput").value.trim();
      if (!target) return;

      document.getElementById("report").classList.remove("visible");
      document.getElementById("errorBox").classList.remove("visible");

      var statusLog  = document.getElementById("statusLog");
      var statusText = document.getElementById("statusText");
      statusLog.classList.add("visible");

      var steps = [
        "Opening case file...",
        "Querying domain registry...",
        "Running malware scan across 93 engines...",
        "Checking Google Safe Browsing...",
        "Verifying SSL certificate live...",
        "Searching 20 global registries...",
        "Scanning Reddit and community signals...",
        "Checking UN and ICIJ sanctions lists...",
        "Running URLScan live page analysis...",
        "Checking Wayback Machine history...",
        "Consulting AI analyst...",
        "Compiling final report..."
      ];

      var i = 0;
      var interval = setInterval(function() {
        if (i < steps.length) { statusText.textContent = steps[i++]; }
      }, 1200);

      document.getElementById("searchBtn").disabled = true;

      var body = { target: target };
      if (userToken) body.user_token = userToken;

      fetch(BACKEND + "/investigate", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      }).then(function(res) {
        clearInterval(interval);
        document.getElementById("searchBtn").disabled = false;
        statusLog.classList.remove("visible");

        if (res.status === 429) {
          showError("Free tier limit reached - 3 investigations/day. Upgrade to Pro for unlimited access.");
          return null;
        }
        return res.json().then(function(data) {
          if (!res.ok) { showError(data.detail || "Investigation failed. Please try again."); return null; }
          return data;
        });
      }).then(function(data) {
        if (data) renderReport(data);
      }).catch(function() {
        clearInterval(interval);
        document.getElementById("searchBtn").disabled = false;
        statusLog.classList.remove("visible");
        showError("Could not reach the investigation server. Please try again.");
      });
    }

    // ── Render ────────────────────────────────────────────────────────────────
    function renderReport(r) {
      var block = document.getElementById("verdictBlock");
      var stamp = document.getElementById("verdictStamp");
      block.className = "verdict-block " + r.verdict;
      stamp.className = "verdict-stamp " + r.verdict;
      var labels = { GREEN: "SAFE", YELLOW: "CAUTION", RED: "DANGER" };
      stamp.textContent = labels[r.verdict] || r.verdict;
      document.getElementById("verdictScore").textContent = "RISK SCORE: " + r.score + "/100";
      document.getElementById("verdictQuote").textContent = '"' + r.verdict_summary + '"';

      var list = document.getElementById("findingsList");
      list.innerHTML = "";
      (r.findings || []).forEach(function(f) {
        var tc = f.tag === "RISK" ? "tag-risk" : f.tag === "OK" ? "tag-ok" : "tag-caution";
        list.innerHTML += '<div class="finding-item"><div class="finding-icon">' + f.icon + '</div><div class="finding-text"><span class="finding-tag ' + tc + '">' + f.tag + '</span>' + f.text + '</div></div>';
      });

      document.getElementById("narrativeText").textContent = r.narrative;

      var grid = document.getElementById("dataGrid");
      grid.innerHTML = "";
      Object.entries(r.raw_labels || {}).forEach(function(entry) {
        grid.innerHTML += '<div class="data-cell"><div class="data-cell-label">' + entry[0] + '</div><div class="data-cell-value">' + entry[1] + '</div></div>';
      });

      document.getElementById("report").classList.add("visible");
      document.getElementById("report").scrollIntoView({ behavior: "smooth" });
    }

    function toggleRaw() {
      var grid = document.getElementById("dataGrid");
      var tog  = document.getElementById("rawToggle");
      grid.classList.toggle("open");
      tog.textContent = grid.classList.contains("open") ? "-" : "+";
    }

    function showError(msg) {
      var box = document.getElementById("errorBox");
      box.textContent = msg;
      box.classList.add("visible");
    }
  </script>
</body>
</html>
